üß† REGRA DE OURO (guarda isso)

server.js ‚Üí s√≥ sobe servidor e conecta rotas

routes/*.js ‚Üí define endpoints

controllers/*.js ‚Üí regra de neg√≥cio

middlewares/*.js ‚Üí seguran√ßa

Kingstar Intranet - Documenta√ß√£o T√©cnica
========================================
Vers√£o do ciclo: 1
Data de conclus√£o: 08/02/2026
Autores: Johnatan Quenes

1. Objetivo do ciclo
-------------------
Implementar o ciclo completo de autentica√ß√£o e gerenciamento de usu√°rios no sistema:
- Cadastro de novos usu√°rios (perfil Pendente)
- Aprova√ß√£o de usu√°rios por ADMIN
- Login com JWT
- Redirecionamento baseado em role (ADMIN -> admin.html, USER -> dashboard.html)
- Controle de acesso √†s p√°ginas e menus (sidebar din√¢mica)
- Registro de a√ß√µes em log de auditoria

2. Estrutura de arquivos principais
-----------------------------------
- `server.js` -> Servidor Express, defini√ß√£o de rotas e p√°ginas
- `routes/authRoutes.js` -> Cadastro e login
- `routes/adminRoutes.js` -> Aprova√ß√£o e listagem de usu√°rios pendentes
- `middlewares/authMiddleware.js` -> Verifica token JWT
- `middlewares/adminMiddleware.js` -> Bloqueia acesso para n√£o-admin
- `public/admin.html` -> Tela de gest√£o de usu√°rios
- `public/dashboard.html` -> Dashboard do usu√°rio comum
- `public/assets/js/admin.js` -> L√≥gica de fetch e aprovar usu√°rios
- `public/assets/js/dashboard.js` -> Dashboard de KPIs
- `public/assets/js/sidebar.js` -> Controle de visibilidade de menus por role/setor
- `public/assets/js/auth.js` -> Cadastro e login
- `data/usuarios.json` -> Base de usu√°rios
- `utils/auditLog.js` -> Registro de logs de auditoria

3. Fluxo de autentica√ß√£o
------------------------
1. Usu√°rio realiza cadastro atrav√©s de `auth.html`:
   - Campos: Nome, Email, Senha, Setor
   - Usu√°rio √© criado com `ativo: false` (pendente)
   - Modal confirma envio e alerta "Aguarde aprova√ß√£o"
   
2. Admin faz login (`admin.html`) e v√™ a lista de usu√°rios pendentes:
   - Fetch GET `/api/admin/usuarios-pendentes`
   - Aprova√ß√£o via PUT `/api/admin/usuarios/:id/ativar`
   - Ao aprovar, usu√°rio recebe `ativo: true` no JSON e log de auditoria √© gravado

3. Login:
   - POST `/api/login` com email e senha
   - JWT gerado para usu√°rios ativos
   - Token salvo no `localStorage`
   - Token decodificado para extrair `role` e `setor`
   - Redirecionamento:
     - `ADMIN` -> `/admin.html`
     - `USER` -> `/dashboard.html`
   
4. Controle de acesso:
   - `authMiddleware` protege rotas API
   - `adminMiddleware` bloqueia rotas administrativas
   - `sidebar.js` mostra/esconde menus conforme role/setor

5. Auditoria:
   - `utils/auditLog.js` grava logs em `data/audit.log`
   - Formato: `[ISO Date] id (ROLE) - A√ß√£o`

4. Erros e aprendizados
-----------------------
- **Erro 1:** Vari√°vel `usuario` n√£o definida ao chamar `auditLog`  
  - Causa: c√≥digo tentava logar antes de verificar se o usu√°rio existia  
  - Corre√ß√£o: verificar exist√™ncia do usu√°rio antes de chamar `auditLog`

- **Erro 2:** Rotas inconsistentes `/dashboard` vs `/dashboard.html`  
  - Causa: duplicidade e falta de padroniza√ß√£o  
  - Corre√ß√£o: padronizar rotas no server.js e nunca repetir endpoints

- **Erro 3:** Vari√°vel `data` ou `token` declaradas m√∫ltiplas vezes no frontend  
  - Causa: scripts JS separados declarando mesmas vari√°veis globais  
  - Corre√ß√£o: encapsular cada m√≥dulo com `let` ou `const` local, evitar redeclara√ß√£o global

- **Erro 4:** Usu√°rio pendente conseguia logar  
  - Causa: falta de checagem de `ativo` no login  
  - Corre√ß√£o: verifica√ß√£o `if (!user.ativo) return erro` implementada no authRoutes

- **Erro 5:** Sidebar bloqueando acesso indevido  
  - Causa: l√≥gica de exibi√ß√£o de menus sendo interpretada como bloqueio  
  - Corre√ß√£o: separar l√≥gica de **exibi√ß√£o de menus** da **valida√ß√£o de acesso**  

- **Erro 6:** Senhas bcrypt n√£o conhecidas para testes  
  - Solu√ß√£o: criar usu√°rio de teste com senha conhecida, aprovar manualmente via JSON para testes

5. Observa√ß√µes finais
---------------------
- Ciclo 1 completo com autentica√ß√£o, aprova√ß√£o de usu√°rios, redirecionamento baseado em role, controle de sidebar e auditoria
- Sistema pronto para o segundo ciclo: dashboards avan√ßados, KPIs din√¢micos, relat√≥rios, logs detalhados, e melhorias de UX
- Todos os erros foram documentados para **n√£o repetir falhas no futuro**

